<!DOCTYPE html>
<svg width="600" height="600" font-family="sans-serif" font-size="10" text-anchor="middle"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-queue/3.0.4/d3-queue.min.js"></script>
<body>
    <form>
        <label for="year">Please select a year: </label>
        <input type="range" min=2011 max=2017 step=1 id="year" value=2011 oninput="selected_year.value = year.value">
        <output name="selected_year" id="selected_year">2011</output>
    </form>
<script>

var svg = d3.select("svg"),
    width = 500,
    height = 500;

var format = d3.format(",d");

var color = d3.scaleOrdinal(d3.schemeGreens[6]);

var pack = d3.pack()
    .size([width, height])
    .padding(1.5);
    
var data = {};

function draw(year) {
  
    var classes = data[year];
    
    var t = d3.transition()
        .duration(500);

  var root = d3.hierarchy({children: classes})
      .sum(function(d) { return  d.value; })
      .each(function(d) {
        if (id = d.data.id) {
          var id, i = id.lastIndexOf(".");
          d.id = id;
          d.package = id.slice(0, i);
          d.class = id.slice(i+1);
            d.kind = id.slice(3, i);
        }
      });
  
  var node = svg.selectAll(".node")
    .data(pack(root).leaves())
    .enter().append("g")
    .attr("class", "node")
  //.attr("r", function(d) { return console.log(d.r); d.r; })
    .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
    
   var circle = svg.selectAll("circle").data(pack(root).leaves());

      
    circle.exit().remove();
    

    circle
        .transition(t).attr("id", function(d) { return d.class; })
      .attr("r", function(d) { console.log(d.r); return  d.r; })
      .style("fill", function(d) { return color(d.package); })
     .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
    

     node.append("clipPath")
      .attr("id", function(d) { return "clip-" + d.id; })
    .append("use")
      .attr("xlink:href", function(d) { return "#" + d.id; });

    circle.enter().append("circle")
        .attr("id", function(d) { return d.class; })
      .attr("r", function(d) { console.log(d.r); return  d.r; })
     .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
      .style("fill", function(d) { return color(d.package); });
    
    var text = svg.selectAll("text")
    .data(pack(root).leaves())
    .enter().append("g").append("text")
      .attr("clip-path", function(d) { return "url(#clip-" + d.id + ")"; })
    .selectAll("tspan")
    .data(function(d) { return d.kind.split(/(?=[A-Z][^A-Z])/g); })
    .enter().append("tspan")
      .attr("x", 0)
      .attr("y", function(d, i, nodes) { return 13 + (i - nodes.length / 2 - 0.5) * 10; }).text(function(d) { return d; });
    
    d3.selectAll("text").transition(t).attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
    
        
    d3.selectAll("#China").style("stroke","#CC333F").style("stroke-width", 2).style("stroke-opacity", 0.7);
    d3.selectAll("#Us").style("stroke","#319ef7").style("stroke-width", 2).style("stroke-opacity", 0.7);
}
    
    d3.queue()
    .defer(d3.csv, 'air2017.csv')
    .defer(d3.csv, 'air2017.csv')
    .defer(d3.csv, 'air2015.csv')
    .defer(d3.csv, 'air2014.csv')
    .defer(d3.csv, 'air2013.csv')
    .defer(d3.csv, 'air2013.csv')
    .defer(d3.csv, 'air2011.csv')
    .await(function(error, d2017,d2017, d2015, d2014, d2013, d2013,d2011) {
        data['2011'] = d2011;
        data['2012'] = d2013;
        data['2013'] = d2013;
        data['2014'] = d2014;
        data['2015'] = d2015;
        data['2016'] = d2015;
        data['2017'] = d2017;
        draw('2011');
    });

var slider = d3.select('#year');
    
slider.on('change', function() {
     draw(this.value);
    console.log(this.value);
    
});

</script>
    </body>